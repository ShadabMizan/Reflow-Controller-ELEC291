0000              1   ;This program receives keyboard input from the PS/2 port on the DE1-SOC
0000              2   ;----------------------------------------;
0000              3   ;                  Workflow:             ;
0000              4   ;         1. Initialize PS/2 pins        ;
0000              5   ;         2. Wait for falling edge       ;
0000              6   ;                of PS/2 clock           ;
0000              7   ;         3. Read PS/2 data stream       ;
0000              8   ;----------------------------------------;
0000              9   ;|Start Bit|SCANCODE|Parity Bit|Stop Bit|;
0000             10   ;----------------------------------------;
0000             11   ;           ^^^^^^^^                     ;
0000             12   ;           8-bit val                    ;
0000             13   ;         4. If scancode == 0xF0,        ;
0000             14   ;            interpret as key release    ;
0000             15   ;         5. Else, interpret as          ;
0000             16   ;            key press                   ;
0000             17   ;----------------------------------------;
                 19   $LIST
0000             21   CLK EQU 33333333
0000             22   TIMER_10ms EQU (65536-(CLK/(12*100)))
0000             23   PS2_DAT EQU P3.3
0000             24   RELEASE_FLAG BIT 20h.0
0000             25   SET_FLAG BIT 20h.1
0000             26   MODE BIT 20h.2 ;0=Soak, 1=Reflow
0000             27   PARAM BIT 20h.3;0=Temp, 1=Time
0000             28   
0000             29   cseg
0000 020228      30            ljmp MainProgram
0003             31            
0003             32            ;Interrupt on keypress at address 0003h
0003             33            org 0003h
0003 020194      34            ljmp PS2_Interrupt
0006             35            
0006             36            ;Scancode to ASCII lookup table
0100             37            org 0100h
0100             38   ASCII_TABLE:
0100 00000000    39            DB 0, 0, 0, 0, 0, 0, 0, 0        ; 00-07
     00000000
0108 00000000    40            DB 0, 0, 0, 0, 0, 0, '`', 0      ; 08-0F
     00006000
0110 00000000    41            DB 0, 0, 0, 0, 0, 'q', '1', 0    ; 10-17
     00713100
0118 00007A73    42            DB 0, 0, 'z', 's', 'a', 'w', '2', 0  ; 18-1F
     61773200
0120 00637864    43            DB 0, 'c', 'x', 'd', 'e', '4', '3', 0  ; 20-27
     65343300
0128 00207666    44            DB 0, ' ', 'v', 'f', 't', 'r', '5', 0  ; 28-2F
     74723500
0130 006E6268    45            DB 0, 'n', 'b', 'h', 'g', 'y', '6', 0  ; 30-37
     67793600
0138 00006D6A    46            DB 0, 0, 'm', 'j', 'u', '7', '8', 0    ; 38-3F
     75373800
0140 002C6B69    47            DB 0, ',', 'k', 'i', 'o', '0', '9', 0  ; 40-47
     6F303900
0148 002E2F6C    48            DB 0, '.', '/', 'l', ';', 'p', '-', 0  ; 48-4F
     3B702D00
0150 00002700    49            DB 0, 0, 27h, 0, '[', '=', 0, 0        ; 50-57 (27h = apostrophe)
     5B3D0000
0158 00000A5D    50            DB 0, 0, 0Ah, ']', 0, 5Ch, 0, 0          ; 58-5F (0Ah = decimal 10 = Enter/newline key)
     005C0000
0160 00000000    51            DB 0, 0, 0, 0, 0, 0, 0, 0              ; 60-67
     00000000
0168 00000000    52            DB 0, 0, 0, 0, 0, 0, 0, 0              ; 68-6F
     00000000
0170 00000000    53            DB 0, 0, 0, 0, 0, 0, 0, 0              ; 70-77
     00000000
0178 00000000    54            DB 0, 0, 0, 0, 0, 0, 0, 0              ; 78-7F
     00000000
0180             55   
0180             56   Initialize_PS2:
0180             57            ;Configure serial protocol for PS/2
0180 D2B3        58            setb PS2_DAT
0182 D288        59            setb IT0         ;Setting IT0 makes external interrupts edge-triggered rather than state-triggered
0184 D2A8        60            setb EX0         ;Enable external interrupts
0186 D2AF        61            setb EA          ;Enable interrupts
0188 7800        62            mov R0, #0               ;Stores what bit we're reading
018A 7900        63            mov R1, #0               ;Stores values of data
018C C200        64            clr RELEASE_FLAG
018E 22          65            ret
018F             66            
018F             67   Scancode_To_ASCII:
018F 900100      68            mov DPTR, #ASCII_TABLE
0192 93          69            movc A, @A+DPTR
0193 22          70            ret
0194             71            
0194             72   PS2_Interrupt:
0194 C0E0        73            push ACC
0196 C0D0        74            push PSW
0198             75            
0198 E8          76            mov A, R0
0199             77            ;If we're at the start of a frame, validate start bit before incrementing
0199 B40004      78            cjne A, #0, NotAtStart
019C A2B3        79            mov C, PS2_DAT
019E 4007        80            jc jump    ;If start bit is 1, wait for valid start (should be 0)
01A0             81            
01A0             82   NotAtStart:
01A0 08          83            inc R0
01A1 E8          84            mov A, R0
01A2             85            ;Ignore start bit
01A2 B40105      86            cjne A, #1, CheckData
01A5 807C        87            sjmp PS2_Done
01A7             88            
01A7             89   jump:
01A7 020223      90            ljmp PS2_Done
01AA             91            
01AA             92   CheckData:
01AA             93            ;Read data bits
01AA C3          94            clr C
01AB 940A        95            subb A, #10      ;Carry if A < 10 (bits 2-9)
01AD 5062        96            jnc CheckIfDone
01AF A2B3        97            mov C, PS2_DAT   ;Read data line
01B1 E9          98            mov A, R1
01B2 13          99            rrc A            ;Shift into R1
01B3 F9         100            mov R1, A
01B4 E8         101            mov A, R0
01B5 B4096B     102            cjne A, #9, PS2_Done
01B8 E9         103            mov A, R1
01B9 B4F004     104            cjne A, #0F0h, NotRelease
01BC D200       105            setb RELEASE_FLAG ;stop code
01BE 8063       106            sjmp PS2_Done
01C0            107   NotRelease:
01C0            108            ;We haven't let go
01C0 12018F     109            lcall Scancode_To_ASCII
01C3 605E       110            jz PS2_Done
01C5 F5E8       111            mov LEDRA, A      
01C7 B4710B     112            cjne A, #'q', NotQ
01CA C201       113            clr SET_FLAG
01CC C202       114            clr MODE
01CE C203       115            clr PARAM
01D0 759500     116            mov LEDRB, #0x00
01D3 804E       117            sjmp PS2_Done
01D5            118            
01D5            119   NotQ:
01D5 20010A     120            jb SET_FLAG, Setting
01D8 B46348     121            cjne A, #'c', PS2_Done
01DB D201       122            setb SET_FLAG
01DD 759501     123            mov LEDRB, #0x01
01E0 8041       124            sjmp PS2_Done
01E2            125            
01E2            126   Setting:
01E2 759501     127            mov LEDRB, #0x01
01E5 B47307     128            cjne A, #'s', CheckR
01E8 C202       129            clr MODE
01EA 759502     130            mov LEDRB, #0b10
01ED 8034       131            sjmp PS2_Done
01EF            132            
01EF            133   CheckR:
01EF B47207     134            cjne A, #'r', CheckT
01F2 D202       135            setb MODE
01F4 759502     136            mov LEDRB, #0b10
01F7 802A       137            sjmp PS2_Done
01F9            138            
01F9            139   CheckT:
01F9 B47407     140            cjne A, #'t', CheckX
01FC D203       141            setb PARAM
01FE 759503     142            mov LEDRB, #0b11
0201 8020       143            sjmp PS2_Done
0203            144            
0203            145   CheckX:
0203 B4781D     146            cjne A, #'x', PS2_Done
0206 C203       147            clr PARAM
0208 759503     148            mov LEDRB, #0b11
020B 8016       149            sjmp PS2_Done
020D            150   
020D            151   ClearRel:
020D C200       152            clr RELEASE_FLAG 
020F 8012       153            sjmp PS2_Done
0211            154   CheckIfDone:
0211            155            ;Wait for Stop Bit
0211 B40B08     156            cjne A, #11, CheckOverflow
0214 8000       157            sjmp Reset
0216            158            
0216            159   Reset:
0216            160            ;Resets so we're ready for next keypress
0216 7800       161            mov R0, #0
0218 7900       162            mov R1, #0
021A 8007       163            sjmp PS2_Done
021C            164   CheckOverflow:
021C            165            ;Prevents from going out of sync (this was a problem because we're not explicitly checking the parity bit)
021C C3         166            clr C
021D 940C       167            subb A, #12
021F 4002       168            jc PS2_Done
0221 80F3       169            sjmp Reset
0223            170   PS2_Done:
0223 D0D0       171            pop PSW
0225 D0E0       172            pop ACC
0227 32         173            reti
0228            174   MainProgram:
0228 75E800     175            mov LEDRA, #0X00
022B 759500     176            mov LEDRB, #0x00
022E 75817F     177       mov sp, #0x7f
0231 120180     178       lcall Initialize_PS2
0234            179   forever:
0234 80FE       180            sjmp forever
0236            181   end
