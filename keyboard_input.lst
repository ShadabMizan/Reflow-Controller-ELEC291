0000              1   ;This program receives keyboard input from the PS/2 port on the DE1-SOC
0000              2   ;----------------------------------------;
0000              3   ;                  Workflow:             ;
0000              4   ;         1. Initialize PS/2 pins        ;
0000              5   ;         2. Wait for falling edge       ;
0000              6   ;                of PS/2 clock           ;
0000              7   ;         3. Read PS/2 data stream       ;
0000              8   ;----------------------------------------;
0000              9   ;|Start Bit|SCANCODE|Parity Bit|Stop Bit|;
0000             10   ;----------------------------------------;
0000             11   ;           ^^^^^^^^                     ;
0000             12   ;           8-bit val                    ;
0000             13   ;         4. If scancode == 0xF0,        ;
0000             14   ;            interpret as key release    ;
0000             15   ;         5. Else, interpret as          ;
0000             16   ;            key press                   ;
0000             17   ;----------------------------------------;
                 19   $LIST
0000             21   CLK EQU 33333333
0000             22   TIMER_10ms EQU (65536-(CLK/(12*100)))
0000             23   PS2_DAT BIT P3.3
0000             24   RELEASE_FLAG BIT 20h
0000             25   cseg
0000 020060      26            ljmp MainProgram
0003             27            
0003             28            ;Interrupt on keypress at address 0003h
0003             29            org 0003h
0003 020015      30            ljmp PS2_Interrupt
0006             31   Initialize_PS2:
0006             32            ; Configure serial protocol for PS/2
0006 D2B3        33            setb PS2_DAT
0008 D288        34            setb IT0         ;Setting IT0 makes external interrupts edge-triggered rather than state-triggered
000A D2A8        35            setb EX0         ;Enable external interrupts
000C D2AF        36            setb EA          ;Enable interrupts
000E 7800        37            mov R0, #0               ;Stores what bit we're reading
0010 7900        38            mov R1, #0               ;Stores values of data
0012 C220        39            clr RELEASE_FLAG
0014 22          40            ret
0015             41   PS2_Interrupt:
0015 C0E0        42            push ACC
0017 C0D0        43            push PSW
0019             44            
0019 E8          45            mov A, R0
001A             46            ;If we're at the start of a frame, validate start bit before incrementing
001A B40004      47            cjne A, #0, NotAtStart
001D A2B3        48            mov C, PS2_DAT
001F 403A        49            jc PS2_Done    ;If start bit is 1, wait for valid start (should be 0)
0021             50            
0021             51   NotAtStart:
0021 08          52            inc R0
0022 E8          53            mov A, R0
0023             54            ;Ignore start bit
0023 B40102      55            cjne A, #1, CheckData
0026 8033        56            sjmp PS2_Done
0028             57   CheckData:
0028             58            ;Read data bits
0028 C3          59            clr C
0029 940A        60            subb A, #10      ; Carry set if A < 10 (bits 2-9)
002B 501C        61            jnc CheckIfDone
002D A2B3        62            mov C, PS2_DAT   ; Read data line
002F E9          63            mov A, R1
0030 13          64            rrc A            ; Shift into R1
0031 F9          65            mov R1, A
0032 E8          66            mov A, R0
0033 B40925      67            cjne A, #9, PS2_Done
0036 E9          68            mov A, R1
0037 B4F004      69            cjne A, #0F0h, NotRelease
003A D220        70            setb RELEASE_FLAG ; stop code
003C 801D        71            sjmp PS2_Done
003E             72   NotRelease:
003E             73            ;We haven't let g
003E 202004      74            jb RELEASE_FLAG, ClearRel
0041 F5E8        75            mov LEDRA, A      
0043 8016        76            sjmp PS2_Done
0045             77   ClearRel:
0045 C220        78            clr RELEASE_FLAG 
0047 8012        79            sjmp PS2_Done
0049             80   CheckIfDone:
0049             81            ;Wait for Stop Bit
0049 B40B08      82            cjne A, #11, CheckOverflow
004C 8000        83            sjmp Reset
004E             84            
004E             85   Reset:
004E             86            ;Resets so we're ready for next keypress
004E 7800        87            mov R0, #0
0050 7900        88            mov R1, #0
0052 8007        89            sjmp PS2_Done
0054             90   CheckOverflow:
0054             91            ;Prevents from going out of sync
0054 C3          92            clr C
0055 940C        93            subb A, #12
0057 4002        94            jc PS2_Done
0059 80F3        95            sjmp Reset
005B             96   PS2_Done:
005B D0D0        97            pop PSW
005D D0E0        98            pop ACC
005F 32          99            reti
0060            100   MainProgram:
0060 75E800     101            mov LEDRA, #0X00
0063 759500     102            mov LEDRB, #0x00
0066 75817F     103       mov sp, #0x7f
0069 120006     104       lcall Initialize_PS2
006C            105   forever:
006C 80FE       106            sjmp forever
006E            107   en
