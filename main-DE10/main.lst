                 -1   $MODMAX10
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   P0             DATA 0x80
0000              5   SP             DATA 0x81
0000              6   DPL            DATA 0x82
0000              7   DPH            DATA 0x83
0000              8   PCON           DATA 0x87
0000              9   TCON           DATA 0x88
0000             10   TMOD           DATA 0x89
0000             11   TL0            DATA 0x8a
0000             12   TL1            DATA 0x8b
0000             13   TH0            DATA 0x8c
0000             14   TH1            DATA 0x8d
0000             15   P1             DATA 0x90
0000             16   SCON           DATA 0x98
0000             17   SBUF           DATA 0x99
0000             18   P2             DATA 0xa0
0000             19   IE             DATA 0xa8
0000             20   P3             DATA 0xb0
0000             21   IP             DATA 0xb8
0000             22   PSW            DATA 0xd0
0000             23   ACC            DATA 0xe0
0000             24   B              DATA 0xf0
0000             25   T2CON          DATA 0xc8
0000             26   RCAP2L         DATA 0xca
0000             27   RCAP2H         DATA 0xcb
0000             28   TL2            DATA 0xcc
0000             29   TH2            DATA 0xcd
0000             30   DPS            DATA 0x86
0000             31   DPH1           DATA 0x85
0000             32   DPL1           DATA 0x84
0000             33   HEX0           DATA 0x91
0000             34   HEX1           DATA 0x92
0000             35   HEX2           DATA 0x93
0000             36   HEX3           DATA 0x94
0000             37   HEX4           DATA 0x8e
0000             38   HEX5           DATA 0x8f
0000             39   LEDRA          DATA 0xe8
0000             40   LEDRB          DATA 0x95
0000             41   SWA            DATA 0xe8
0000             42   SWB            DATA 0x95
0000             43   KEY            DATA 0xf8
0000             44   P0MOD          DATA 0x9a
0000             45   P1MOD          DATA 0x9b
0000             46   P2MOD          DATA 0x9c
0000             47   P3MOD          DATA 0x9d
0000             48   REP_ADD_L      DATA 0xf1
0000             49   REP_ADD_H      DATA 0xf2
0000             50   REP_VALUE      DATA 0xf3
0000             51   DEBUG_CALL_L   DATA 0xfa
0000             52   DEBUG_CALL_H   DATA 0xfb
0000             53   BPC            DATA 0xfc
0000             54   BPS            DATA 0xfd
0000             55   BPAL           DATA 0xfe
0000             56   BPAH           DATA 0xff
0000             57   LBPAL          DATA 0xfa
0000             58   LBPAH          DATA 0xfb
0000             59   P4             DATA 0xc0
0000             60   P4MOD          DATA 0xc1
0000             61   XRAMUSEDAS     DATA 0xc3
0000             62   UFM_ADD0       DATA 0xe1
0000             63   UFM_ADD1       DATA 0xe2
0000             64   UFM_ADD2       DATA 0xe3
0000             65   UFM_DATA0      DATA 0xe4
0000             66   UFM_DATA1      DATA 0xe5
0000             67   UFM_DATA2      DATA 0xe6
0000             68   UFM_DATA3      DATA 0xe7
0000             69   UFM_CONTROL0   DATA 0xe9
0000             70   UFM_CONTROL1   DATA 0xea
0000             71   UFM_CONTROL2   DATA 0xeb
0000             72   UFM_CONTROL3   DATA 0xec
0000             73   UFM_DATA_CMD   DATA 0xed
0000             74   UFM_DATA_STATUS DATA 0xee
0000             75   UFM_CONTROL_CMD DATA 0xef
0000             76   ADC_C          DATA 0xa1
0000             77   ADC_L          DATA 0xa2
0000             78   ADC_H          DATA 0xa3
0000             79   
0000             80   ;--------------------------------------------------------
0000             81   ; special function bits
0000             82   ;--------------------------------------------------------
0000             83   P0_0           BIT 0x80
0000             84   P0_1           BIT 0x81
0000             85   P0_2           BIT 0x82
0000             86   P0_3           BIT 0x83
0000             87   P0_4           BIT 0x84
0000             88   P0_5           BIT 0x85
0000             89   P0_6           BIT 0x86
0000             90   P0_7           BIT 0x87
0000             91   IT0            BIT 0x88
0000             92   IE0            BIT 0x89
0000             93   IT1            BIT 0x8a
0000             94   IE1            BIT 0x8b
0000             95   TR0            BIT 0x8c
0000             96   TF0            BIT 0x8d
0000             97   TR1            BIT 0x8e
0000             98   TF1            BIT 0x8f
0000             99   P1_0           BIT 0x90
0000            100   P1_1           BIT 0x91
0000            101   P1_2           BIT 0x92
0000            102   P1_3           BIT 0x93
0000            103   P1_4           BIT 0x94
0000            104   P1_5           BIT 0x95
0000            105   P1_6           BIT 0x96
0000            106   P1_7           BIT 0x97
0000            107   RI             BIT 0x98
0000            108   TI             BIT 0x99
0000            109   RB8            BIT 0x9a
0000            110   TB8            BIT 0x9b
0000            111   REN            BIT 0x9c
0000            112   SM2            BIT 0x9d
0000            113   SM1            BIT 0x9e
0000            114   SM0            BIT 0x9f
0000            115   P2_0           BIT 0xa0
0000            116   P2_1           BIT 0xa1
0000            117   P2_2           BIT 0xa2
0000            118   P2_3           BIT 0xa3
0000            119   P2_4           BIT 0xa4
0000            120   P2_5           BIT 0xa5
0000            121   P2_6           BIT 0xa6
0000            122   P2_7           BIT 0xa7
0000            123   EX0            BIT 0xa8
0000            124   ET0            BIT 0xa9
0000            125   EX1            BIT 0xaa
0000            126   ET1            BIT 0xab
0000            127   ES             BIT 0xac
0000            128   ET2            BIT 0xad
0000            129   EA             BIT 0xaf
0000            130   P3_0           BIT 0xb0
0000            131   P3_1           BIT 0xb1
0000            132   P3_2           BIT 0xb2
0000            133   P3_3           BIT 0xb3
0000            134   P3_4           BIT 0xb4
0000            135   P3_5           BIT 0xb5
0000            136   P3_6           BIT 0xb6
0000            137   P3_7           BIT 0xb7
0000            138   RXD            BIT 0xb0
0000            139   TXD            BIT 0xb1
0000            140   INT0           BIT 0xb2
0000            141   INT1           BIT 0xb3
0000            142   T0             BIT 0xb4
0000            143   T1             BIT 0xb5
0000            144   WR             BIT 0xb6
0000            145   RD             BIT 0xb7
0000            146   PX0            BIT 0xb8
0000            147   PT0            BIT 0xb9
0000            148   PX1            BIT 0xba
0000            149   PT1            BIT 0xbb
0000            150   PS             BIT 0xbc
0000            151   PT2            BIT 0xbd
0000            152   P              BIT 0xd0
0000            153   F1             BIT 0xd1
0000            154   OV             BIT 0xd2
0000            155   RS0            BIT 0xd3
0000            156   RS1            BIT 0xd4
0000            157   F0             BIT 0xd5
0000            158   AC             BIT 0xd6
0000            159   CY             BIT 0xd7
0000            160   T2CON_0        BIT 0xc8
0000            161   T2CON_1        BIT 0xc9
0000            162   T2CON_2        BIT 0xca
0000            163   T2CON_3        BIT 0xcb
0000            164   T2CON_4        BIT 0xcc
0000            165   T2CON_5        BIT 0xcd
0000            166   T2CON_6        BIT 0xce
0000            167   T2CON_7        BIT 0xcf
0000            168   CP_RL2         BIT 0xc8
0000            169   C_T2           BIT 0xc9
0000            170   TR2            BIT 0xca
0000            171   EXEN2          BIT 0xcb
0000            172   TCLK           BIT 0xcc
0000            173   RCLK           BIT 0xcd
0000            174   EXF2           BIT 0xce
0000            175   TF2            BIT 0xcf
0000            176   LEDRA_0        BIT 0xe8
0000            177   LEDRA_1        BIT 0xe9
0000            178   LEDRA_2        BIT 0xea
0000            179   LEDRA_3        BIT 0xeb
0000            180   LEDRA_4        BIT 0xec
0000            181   LEDRA_5        BIT 0xed
0000            182   LEDRA_6        BIT 0xee
0000            183   LEDRA_7        BIT 0xef
0000            184   SWA_0          BIT 0xe8
0000            185   SWA_1          BIT 0xe9
0000            186   SWA_2          BIT 0xea
0000            187   SWA_3          BIT 0xeb
0000            188   SWA_4          BIT 0xec
0000            189   SWA_5          BIT 0xed
0000            190   SWA_6          BIT 0xee
0000            191   SWA_7          BIT 0xef
0000            192   KEY_0          BIT 0xf8
0000            193   KEY_1          BIT 0xf9
0000            194   KEY_2          BIT 0xfa
0000            195   KEY_3          BIT 0xfb
0000            196   P4_0           BIT 0xc0
0000            197   P4_1           BIT 0xc1
0000            198   P4_2           BIT 0xc2
0000            199   P4_3           BIT 0xc3
0000            200   P4_4           BIT 0xc4
0000            201   P4_5           BIT 0xc5
0000            202   P4_6           BIT 0xc6
0000            203   P4_7           BIT 0xc7
0000              2   
0000              3   ; The Special Function Registers below were added to 'MODMAX10' recently.
0000              4   ; If you are getting an error, uncomment the three lines below.
0000              5   
0000              6   ; ADC_C DATA 0xa1
0000              7   ; ADC_L DATA 0xa2
0000              8   ; ADC_H DATA 0xa3
0000              9   
0000             10   org 0000h
0000 02054D      11       ljmp mycode
0003             12   
002B             13   org 002Bh
002B 020414      14       ljmp Timer2_ISR
002E             15   
0030             16   dseg at 30h
0030             17   ; Math32 variables
0030             18   x:               ds      4
0034             19   y:               ds      4
0038             20   bcd:     ds      5
003D             21   
003D             22   ; PWM variables
003D             23   ticks_per_sec:    ds 2        ; Tick counter for seconds
003F             24   pwm_tick_counter: ds 1
0040             25   pwm_on_ticks:     ds 1
0041             26   pwm:              ds 1    ; 0–100 (% duty cycle)
0042             27   
0042             28   
0000             29   bseg
0000             30   ; math32 bit
0000             31   mf:              dbit 1
0001             32   
0001             33   ; PWM bit
0001             34   seconds_flag: dbit 1
0002             35   oven_enabled:     dbit 1      ; PWM state
0003             36   
0003             37   CLK              EQU 33333333    ; DE10-Lite CV-8052 = 33.333 MHz
0003             38   TIMER2_RATE      EQU 2048        ; 2048 Hz for a 488 u-sec period/per tick
0003             39   TIMER2_RELOAD    EQU ((65536-(CLK/(12*TIMER2_RATE))))
0003             40   PWM_PERIOD_TICKS EQU 20          ; 20 ticks = 9.77ms period = 102 Hz PWM
0003             41   
0003             42   SSR_PIN         EQU P3.7
0003             43   
002E             44   CSEG
002E             45   
002E             46   InitSerialPort:
002E 758920      47       mov TMOD, #20H        ; Timer1 mode 2
0031 758DF7      48       mov TH1, #0F7H       ; 9600 baud @ 33.333MHz
0034 758BF7      49       mov TL1, #0F7H
0037 D28E        50       setb TR1              ; Start Timer1
0039 759850      51       mov SCON, #50H        ; Mode 1, REN enabled
003C D299        52       setb TI               ; Set TI so first transmit works
003E 22          53       ret
003F             54   
003F             55   putchar:
003F 3099FD      56       JNB TI, putchar
0042 C299        57       CLR TI
0044 F599        58       MOV SBUF, a
0046 22          59       RET
0047             60   
0047             61   SendString:
0047 E4          62       CLR A
0048 93          63       MOVC A, @A+DPTR
0049 6006        64       JZ SSDone
004B 12003F      65       LCALL putchar
004E A3          66       INC DPTR
004F 80F6        67       SJMP SendString
0051             68   SSDone:
0051 22          69       ret
0052             70   
                 -1   $include(math32.asm)
                614   $LIST
0344             72   
0344             73   cseg
0344             74   ; These 'equ' must match the wiring between the DE10Lite board and the LCD!
0344             75   ; P0 is in connector JPIO.  Check "CV-8052 Soft Processor in the DE10Lite Board: Getting
0344             76   ; Started Guide" for the details.
0344             77   ELCD_RS equ P1.7
0344             78   ; ELCD_RW equ Px.x ; Not used.  Connected to ground 
0344             79   ELCD_E  equ P1.1
0344             80   ELCD_D4 equ P0.7
0344             81   ELCD_D5 equ P0.5
0344             82   ELCD_D6 equ P0.3
0344             83   ELCD_D7 equ P0.1
                 86   $LIST
047D             88   
047D             89   ; Look-up table for 7-seg displays
047D             90   myLUT:
047D C0F9A4B0    91       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
0482 9282F880    92       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
0487 8883C6A1    93       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
048D             94   
048D             95   Wait50ms:
048D             96   ;33.33MHz, 1 clk per cycle: 0.03us
048D 781E        97            mov R0, #30
048F             98   Wait50ms_L3:
048F 794A        99            mov R1, #74
0491            100   Wait50ms_L2:
0491 7AFA       101            mov R2, #250
0493            102   Wait50ms_L1:
0493 DAFE       103            djnz R2, Wait50ms_L1 ;3*250*0.03us=22.5us
0495 D9FA       104       djnz R1, Wait50ms_L2 ;74*22.5us=1.665ms
0497 D8F6       105       djnz R0, Wait50ms_L3 ;1.665ms*30=50ms
0499 22         106       ret
049A            107   
049A            108   Display_Voltage_7seg:
049A            109            
049A 90047D     110            mov dptr, #myLUT
049D            111   
049D E539       112            mov a, bcd+1
049F C4         113            swap a
04A0 540F       114            anl a, #0FH
04A2 93         115            movc a, @a+dptr
04A3 547F       116            anl a, #0x7f ; Turn on decimal point
04A5 F594       117            mov HEX3, a
04A7            118            
04A7 E539       119            mov a, bcd+1
04A9 540F       120            anl a, #0FH
04AB 93         121            movc a, @a+dptr
04AC F593       122            mov HEX2, a
04AE            123   
04AE E538       124            mov a, bcd+0
04B0 C4         125            swap a
04B1 540F       126            anl a, #0FH
04B3 93         127            movc a, @a+dptr
04B4 F592       128            mov HEX1, a
04B6            129            
04B6 E538       130            mov a, bcd+0
04B8 540F       131            anl a, #0FH
04BA 93         132            movc a, @a+dptr
04BB F591       133            mov HEX0, a
04BD            134            
04BD 22         135            ret
04BE            136   
04BE            137   Display_Voltage_LCD:
04BE C0E0       138            push acc
04C0 7401       138            mov a, #1
04C2 14         138            dec a
04C3 1203DE     138            lcall ?Set_Cursor_2 ; Select column and row
04C6 D0E0       138            pop acc
04C8 7456       139            mov a, #'V'
04CA 120396     140            lcall ?WriteData
04CD 743D       141            mov a, #'='
04CF 120396     142            lcall ?WriteData
04D2            143   
04D2 E539       144            mov a, bcd+1
04D4 C4         145            swap a
04D5 540F       146            anl a, #0FH
04D7 4430       147            orl a, #'0'
04D9 120396     148            lcall ?WriteData
04DC            149            
04DC 742E       150            mov a, #'.'
04DE 120396     151            lcall ?WriteData
04E1            152            
04E1 E539       153            mov a, bcd+1
04E3 540F       154            anl a, #0FH
04E5 4430       155            orl a, #'0'
04E7 120396     156            lcall ?WriteData
04EA            157   
04EA E538       158            mov a, bcd+0
04EC C4         159            swap a
04ED 540F       160            anl a, #0FH
04EF 4430       161            orl a, #'0'
04F1 120396     162            lcall ?WriteData
04F4            163            
04F4 E538       164            mov a, bcd+0
04F6 540F       165            anl a, #0FH
04F8 4430       166            orl a, #'0'
04FA 120396     167            lcall ?WriteData
04FD            168            
04FD 22         169            ret
04FE            170            
04FE            171   Display_Voltage_Serial:
04FE 7456       172            mov a, #'V'
0500 12003F     173            lcall putchar
0503 743D       174            mov a, #'='
0505 12003F     175            lcall putchar
0508            176   
0508 E539       177            mov a, bcd+1
050A C4         178            swap a
050B 540F       179            anl a, #0FH
050D 4430       180            orl a, #'0'
050F 12003F     181            lcall putchar
0512            182            
0512 742E       183            mov a, #'.'
0514 12003F     184            lcall putchar
0517            185            
0517 E539       186            mov a, bcd+1
0519 540F       187            anl a, #0FH
051B 4430       188            orl a, #'0'
051D 12003F     189            lcall putchar
0520            190   
0520 E538       191            mov a, bcd+0
0522 C4         192            swap a
0523 540F       193            anl a, #0FH
0525 4430       194            orl a, #'0'
0527 12003F     195            lcall putchar
052A            196            
052A E538       197            mov a, bcd+0
052C 540F       198            anl a, #0FH
052E 4430       199            orl a, #'0'
0530 12003F     200            lcall putchar
0533            201   
0533 740D       202            mov a, #'\r'
0535 12003F     203            lcall putchar
0538 740A       204            mov a, #'\n'
053A 12003F     205            lcall putchar
053D            206            
053D 22         207            ret
053E            208   
053E 566F6C74   209   Initial_Message:  db 'Voltmeter test', 0
     6D657465
     72207465
     737400
054D            210   
054D            211   mycode:
054D 75817F     212            mov SP, #0x7F
0550 E4         213            clr a
0551 F5E8       214            mov LEDRA, a
0553 F595       215            mov LEDRB, a
0555            216            
0555 12002E     217            lcall InitSerialPort
0558 1203FB     218       lcall Timer2_Init
055B            219            
055B            220            ; COnfigure the pins connected to the LCD as outputs
055B 759AAA     221            mov P0MOD, #10101010b ; P0.1, P0.3, P0.5, P0.7 are outputs.  ('1' makes the pin output)
055E 759B82     222       mov P1MOD, #10000010b ; P1.7 and P1.1 are outputs
0561            223   
0561            224       ; Initial PWM output
0561 759D80     225       mov P3MOD, #10000000b   ; P3.7
0564            226   
0564 75A180     227       mov ADC_C, #0x80 ; Reset ADC
0567 12048D     228            lcall Wait50ms
056A            229   
056A E4         230       clr a
056B F53F       231       mov pwm_tick_counter, a
056D F540       232       mov pwm_on_ticks, a
056F 754100     233       mov pwm, #0
0572            234   
0572 D2AF       235       setb EA              ; Enable global interrupts
0574            236       
0574            237       ; Set initial 0% and apply
0574 754100     238       mov pwm, #0
0577 120467     239       lcall Update_PWM        
057A            240   
057A            241       ; lcall ELCD_4BIT ; Configure LCD in four bit mode
057A            242       ; ; ; For convenience a few handy macros are included in 'LCD_4bit_DE1Lite.inc':
057A            243            ; Set_Cursor(1, 1)
057A            244       ; Send_Constant_String(#Initial_Message)
057A            245            
057A 90053E     246            mov dptr, #Initial_Message
057D 120047     247            lcall SendString
0580 740D       248            mov a, #'\r'
0582 12003F     249            lcall putchar
0585 740A       250            mov a, #'\n'
0587 12003F     251            lcall putchar
058A            252   
058A 754132     253       mov pwm, #50
058D 120467     254       lcall Update_PWM
0590            255   
0590            256       ; Test UART
0590 7454       257       mov a, #'T'
0592 12003F     258       lcall putchar
0595 7445       259       mov a, #'E'
0597 12003F     260       lcall putchar
059A 7453       261       mov a, #'S'
059C 12003F     262       lcall putchar
059F 7454       263       mov a, #'T'
05A1 12003F     264       lcall putchar
05A4 740D       265       mov a, #'\r'
05A6 12003F     266       lcall putchar
05A9 740A       267       mov a, #'\n'
05AB 12003F     268       lcall putchar
05AE            269       
05AE 12048D     270       lcall Wait50ms
05B1            271   
05B1            272   forever:
05B1 75411E     273       mov pwm, #30
05B4 120467     274       lcall Update_PWM
05B7            275   
05B7 1205C9     276       lcall Read_Temperature
05BA 12048D     277            lcall Wait50ms
05BD 12048D     278            lcall Wait50ms
05C0 12048D     279            lcall Wait50ms
05C3 12048D     280            lcall Wait50ms
05C6 0205B1     281            ljmp forever
05C9            282   
05C9            283   ; ----------------------------------------
05C9            284   ; TEMPERATURE ROUTINES
05C9            285   ; ----------------------------------------
05C9            286   Read_Temperature:
05C9 75A180     287       mov ADC_C, #0x80          ; ← FIXED: Use immediate value
05CC 12048D     288       lcall Wait50ms            ; ← ADDED: Wait for conversion
05CF            289   
05CF            290       ; Load 32-bit 'x' with 12-bit adc result
05CF 753300     291       mov x+3, #0
05D2 753200     292       mov x+2, #0
05D5 85A331     293       mov x+1, ADC_H
05D8 85A230     294       mov x+0, ADC_L
05DB            295   
05DB            296       ; Convert to voltage by multiplying by 5.000 and dividing by 4096
05DB 753488     297            mov y+0, #low (5000 % 0x10000) 
05DE 753513     297            mov y+1, #high(5000 % 0x10000) 
05E1 753600     297            mov y+2, #low (5000 / 0x10000) 
05E4 753700     297            mov y+3, #high(5000 / 0x10000) 
05E7 1201B0     298       lcall mul32
05EA 753400     299            mov y+0, #low (4096 % 0x10000) 
05ED 753510     299            mov y+1, #high(4096 % 0x10000) 
05F0 753600     299            mov y+2, #low (4096 / 0x10000) 
05F3 753700     299            mov y+3, #high(4096 / 0x10000) 
05F6 1202A4     300       lcall div32
05F9            301   
05F9            302       ; Convert the Voltage at the ADC to a temperature:
05F9 7534E8     303            mov y+0, #low (1000 % 0x10000) 
05FC 753503     303            mov y+1, #high(1000 % 0x10000) 
05FF 753600     303            mov y+2, #low (1000 / 0x10000) 
0602 753700     303            mov y+3, #high(1000 / 0x10000) 
0605 1201B0     304       lcall mul32
0608 75340C     305            mov y+0, #low (12300 % 0x10000) 
060B 753530     305            mov y+1, #high(12300 % 0x10000) 
060E 753600     305            mov y+2, #low (12300 / 0x10000) 
0611 753700     305            mov y+3, #high(12300 / 0x10000) 
0614 1202A4     306       lcall div32
0617            307   
0617 753416     308            mov y+0, #low (22 % 0x10000) 
061A 753500     308            mov y+1, #high(22 % 0x10000) 
061D 753600     308            mov y+2, #low (22 / 0x10000) 
0620 753700     308            mov y+3, #high(22 / 0x10000) 
0623 1200F7     309       lcall add32
0626            310   
0626 120052     311       lcall hex2bcd
0629 1204FE     312       lcall Display_Voltage_Serial
062C 22         313       ret
062D            314   
062D            315   en
