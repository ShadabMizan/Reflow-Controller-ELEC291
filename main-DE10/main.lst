                 -1   $MODMAX10
0000              1   ;--------------------------------------------------------
0000              2   ; Special Function Registers
0000              3   ;--------------------------------------------------------
0000              4   P0             DATA 0x80
0000              5   SP             DATA 0x81
0000              6   DPL            DATA 0x82
0000              7   DPH            DATA 0x83
0000              8   PCON           DATA 0x87
0000              9   TCON           DATA 0x88
0000             10   TMOD           DATA 0x89
0000             11   TL0            DATA 0x8a
0000             12   TL1            DATA 0x8b
0000             13   TH0            DATA 0x8c
0000             14   TH1            DATA 0x8d
0000             15   P1             DATA 0x90
0000             16   SCON           DATA 0x98
0000             17   SBUF           DATA 0x99
0000             18   P2             DATA 0xa0
0000             19   IE             DATA 0xa8
0000             20   P3             DATA 0xb0
0000             21   IP             DATA 0xb8
0000             22   PSW            DATA 0xd0
0000             23   ACC            DATA 0xe0
0000             24   B              DATA 0xf0
0000             25   T2CON          DATA 0xc8
0000             26   RCAP2L         DATA 0xca
0000             27   RCAP2H         DATA 0xcb
0000             28   TL2            DATA 0xcc
0000             29   TH2            DATA 0xcd
0000             30   DPS            DATA 0x86
0000             31   DPH1           DATA 0x85
0000             32   DPL1           DATA 0x84
0000             33   HEX0           DATA 0x91
0000             34   HEX1           DATA 0x92
0000             35   HEX2           DATA 0x93
0000             36   HEX3           DATA 0x94
0000             37   HEX4           DATA 0x8e
0000             38   HEX5           DATA 0x8f
0000             39   LEDRA          DATA 0xe8
0000             40   LEDRB          DATA 0x95
0000             41   SWA            DATA 0xe8
0000             42   SWB            DATA 0x95
0000             43   KEY            DATA 0xf8
0000             44   P0MOD          DATA 0x9a
0000             45   P1MOD          DATA 0x9b
0000             46   P2MOD          DATA 0x9c
0000             47   P3MOD          DATA 0x9d
0000             48   REP_ADD_L      DATA 0xf1
0000             49   REP_ADD_H      DATA 0xf2
0000             50   REP_VALUE      DATA 0xf3
0000             51   DEBUG_CALL_L   DATA 0xfa
0000             52   DEBUG_CALL_H   DATA 0xfb
0000             53   BPC            DATA 0xfc
0000             54   BPS            DATA 0xfd
0000             55   BPAL           DATA 0xfe
0000             56   BPAH           DATA 0xff
0000             57   LBPAL          DATA 0xfa
0000             58   LBPAH          DATA 0xfb
0000             59   P4             DATA 0xc0
0000             60   P4MOD          DATA 0xc1
0000             61   XRAMUSEDAS     DATA 0xc3
0000             62   UFM_ADD0       DATA 0xe1
0000             63   UFM_ADD1       DATA 0xe2
0000             64   UFM_ADD2       DATA 0xe3
0000             65   UFM_DATA0      DATA 0xe4
0000             66   UFM_DATA1      DATA 0xe5
0000             67   UFM_DATA2      DATA 0xe6
0000             68   UFM_DATA3      DATA 0xe7
0000             69   UFM_CONTROL0   DATA 0xe9
0000             70   UFM_CONTROL1   DATA 0xea
0000             71   UFM_CONTROL2   DATA 0xeb
0000             72   UFM_CONTROL3   DATA 0xec
0000             73   UFM_DATA_CMD   DATA 0xed
0000             74   UFM_DATA_STATUS DATA 0xee
0000             75   UFM_CONTROL_CMD DATA 0xef
0000             76   ADC_C          DATA 0xa1
0000             77   ADC_L          DATA 0xa2
0000             78   ADC_H          DATA 0xa3
0000             79   
0000             80   ;--------------------------------------------------------
0000             81   ; special function bits
0000             82   ;--------------------------------------------------------
0000             83   P0_0           BIT 0x80
0000             84   P0_1           BIT 0x81
0000             85   P0_2           BIT 0x82
0000             86   P0_3           BIT 0x83
0000             87   P0_4           BIT 0x84
0000             88   P0_5           BIT 0x85
0000             89   P0_6           BIT 0x86
0000             90   P0_7           BIT 0x87
0000             91   IT0            BIT 0x88
0000             92   IE0            BIT 0x89
0000             93   IT1            BIT 0x8a
0000             94   IE1            BIT 0x8b
0000             95   TR0            BIT 0x8c
0000             96   TF0            BIT 0x8d
0000             97   TR1            BIT 0x8e
0000             98   TF1            BIT 0x8f
0000             99   P1_0           BIT 0x90
0000            100   P1_1           BIT 0x91
0000            101   P1_2           BIT 0x92
0000            102   P1_3           BIT 0x93
0000            103   P1_4           BIT 0x94
0000            104   P1_5           BIT 0x95
0000            105   P1_6           BIT 0x96
0000            106   P1_7           BIT 0x97
0000            107   RI             BIT 0x98
0000            108   TI             BIT 0x99
0000            109   RB8            BIT 0x9a
0000            110   TB8            BIT 0x9b
0000            111   REN            BIT 0x9c
0000            112   SM2            BIT 0x9d
0000            113   SM1            BIT 0x9e
0000            114   SM0            BIT 0x9f
0000            115   P2_0           BIT 0xa0
0000            116   P2_1           BIT 0xa1
0000            117   P2_2           BIT 0xa2
0000            118   P2_3           BIT 0xa3
0000            119   P2_4           BIT 0xa4
0000            120   P2_5           BIT 0xa5
0000            121   P2_6           BIT 0xa6
0000            122   P2_7           BIT 0xa7
0000            123   EX0            BIT 0xa8
0000            124   ET0            BIT 0xa9
0000            125   EX1            BIT 0xaa
0000            126   ET1            BIT 0xab
0000            127   ES             BIT 0xac
0000            128   ET2            BIT 0xad
0000            129   EA             BIT 0xaf
0000            130   P3_0           BIT 0xb0
0000            131   P3_1           BIT 0xb1
0000            132   P3_2           BIT 0xb2
0000            133   P3_3           BIT 0xb3
0000            134   P3_4           BIT 0xb4
0000            135   P3_5           BIT 0xb5
0000            136   P3_6           BIT 0xb6
0000            137   P3_7           BIT 0xb7
0000            138   RXD            BIT 0xb0
0000            139   TXD            BIT 0xb1
0000            140   INT0           BIT 0xb2
0000            141   INT1           BIT 0xb3
0000            142   T0             BIT 0xb4
0000            143   T1             BIT 0xb5
0000            144   WR             BIT 0xb6
0000            145   RD             BIT 0xb7
0000            146   PX0            BIT 0xb8
0000            147   PT0            BIT 0xb9
0000            148   PX1            BIT 0xba
0000            149   PT1            BIT 0xbb
0000            150   PS             BIT 0xbc
0000            151   PT2            BIT 0xbd
0000            152   P              BIT 0xd0
0000            153   F1             BIT 0xd1
0000            154   OV             BIT 0xd2
0000            155   RS0            BIT 0xd3
0000            156   RS1            BIT 0xd4
0000            157   F0             BIT 0xd5
0000            158   AC             BIT 0xd6
0000            159   CY             BIT 0xd7
0000            160   T2CON_0        BIT 0xc8
0000            161   T2CON_1        BIT 0xc9
0000            162   T2CON_2        BIT 0xca
0000            163   T2CON_3        BIT 0xcb
0000            164   T2CON_4        BIT 0xcc
0000            165   T2CON_5        BIT 0xcd
0000            166   T2CON_6        BIT 0xce
0000            167   T2CON_7        BIT 0xcf
0000            168   CP_RL2         BIT 0xc8
0000            169   C_T2           BIT 0xc9
0000            170   TR2            BIT 0xca
0000            171   EXEN2          BIT 0xcb
0000            172   TCLK           BIT 0xcc
0000            173   RCLK           BIT 0xcd
0000            174   EXF2           BIT 0xce
0000            175   TF2            BIT 0xcf
0000            176   LEDRA_0        BIT 0xe8
0000            177   LEDRA_1        BIT 0xe9
0000            178   LEDRA_2        BIT 0xea
0000            179   LEDRA_3        BIT 0xeb
0000            180   LEDRA_4        BIT 0xec
0000            181   LEDRA_5        BIT 0xed
0000            182   LEDRA_6        BIT 0xee
0000            183   LEDRA_7        BIT 0xef
0000            184   SWA_0          BIT 0xe8
0000            185   SWA_1          BIT 0xe9
0000            186   SWA_2          BIT 0xea
0000            187   SWA_3          BIT 0xeb
0000            188   SWA_4          BIT 0xec
0000            189   SWA_5          BIT 0xed
0000            190   SWA_6          BIT 0xee
0000            191   SWA_7          BIT 0xef
0000            192   KEY_0          BIT 0xf8
0000            193   KEY_1          BIT 0xf9
0000            194   KEY_2          BIT 0xfa
0000            195   KEY_3          BIT 0xfb
0000            196   P4_0           BIT 0xc0
0000            197   P4_1           BIT 0xc1
0000            198   P4_2           BIT 0xc2
0000            199   P4_3           BIT 0xc3
0000            200   P4_4           BIT 0xc4
0000            201   P4_5           BIT 0xc5
0000            202   P4_6           BIT 0xc6
0000            203   P4_7           BIT 0xc7
0000              2   
0000              3   ; The Special Function Registers below were added to 'MODMAX10' recently.
0000              4   ; If you are getting an error, uncomment the three lines below.
0000              5   
0000              6   ; ADC_C DATA 0xa1
0000              7   ; ADC_L DATA 0xa2
0000              8   ; ADC_H DATA 0xa3
0000              9   
0000             10   org 0000h
0000 02054F      11       ljmp mycode
0003             12   
002B             13   org 002Bh
002B 020414      14       ljmp Timer2_ISR
002E             15   
0030             16   dseg at 30h
0030             17   ; Math32 variables
0030             18   x:               ds      4
0034             19   y:               ds      4
0038             20   bcd:     ds      5
003D             21   
003D             22   ; PWM variables
003D             23   ticks_per_sec:    ds 2        ; Tick counter for seconds
003F             24   pwm_tick_counter: ds 1
0040             25   pwm_on_ticks:     ds 1
0041             26   pwm:              ds 1    ; 0â€“100 (% duty cycle)
0042             27   
0042             28   
0000             29   bseg
0000             30   ; math32 bit
0000             31   mf:              dbit 1
0001             32   
0001             33   ; PWM bit
0001             34   seconds_flag: dbit 1
0002             35   oven_enabled:     dbit 1      ; PWM state
0003             36   
0003             37   FREQ   EQU 33333333
0003             38   BAUD   EQU 115200
0003             39   
0003             40   CLK              EQU 33333333    ; DE10-Lite CV-8052 = 33.333 MHz
0003             41   TIMER2_RATE      EQU 2048        ; 2048 Hz for a 488 u-sec period/per tick
0003             42   TIMER2_RELOAD    EQU ((65536-(CLK/(12*TIMER2_RATE))))
0003             43   PWM_PERIOD_TICKS EQU 20          ; 20 ticks = 9.77ms period = 102 Hz PWM
0003             44   
0003             45   SSR_PIN         EQU P3.7
0003             46   
002E             47   CSEG
002E             48   
002E             49   InitSerialPort:
002E             50            ; Configure serial port and baud rate
002E 758920      51       mov TMOD, #20H        ; Timer1 mode 2 (8-bit auto reload)
0031 758DF7      52       mov TH1, #-(FREQ/(32*BAUD))
0034 858D8B      53       mov TL1, TH1
0037 D28E        54       setb TR1
0039 759850      55       mov SCON, #50H
003C D299        56       setb TI
003E 22          57            ret
003F             58   
003F             59   putchar:
003F 3099FD      60       JNB TI, putchar
0042 C299        61       CLR TI
0044 F599        62       MOV SBUF, a
0046 22          63       RET
0047             64   
0047             65   SendString:
0047 E4          66       CLR A
0048 93          67       MOVC A, @A+DPTR
0049 6006        68       JZ SSDone
004B 12003F      69       LCALL putchar
004E A3          70       INC DPTR
004F 80F6        71       SJMP SendString
0051             72   SSDone:
0051 22          73       ret
0052             74   
                 -1   $include(math32.asm)
                614   $LIST
0344             76   
0344             77   cseg
0344             78   ; These 'equ' must match the wiring between the DE10Lite board and the LCD!
0344             79   ; P0 is in connector JPIO.  Check "CV-8052 Soft Processor in the DE10Lite Board: Getting
0344             80   ; Started Guide" for the details.
0344             81   ELCD_RS equ P1.7
0344             82   ; ELCD_RW equ Px.x ; Not used.  Connected to ground 
0344             83   ELCD_E  equ P1.1
0344             84   ELCD_D4 equ P0.7
0344             85   ELCD_D5 equ P0.5
0344             86   ELCD_D6 equ P0.3
0344             87   ELCD_D7 equ P0.1
                 90   $LIST
047F             92   
047F             93   ; Look-up table for 7-seg displays
047F             94   myLUT:
047F C0F9A4B0    95       DB 0xC0, 0xF9, 0xA4, 0xB0, 0x99        ; 0 TO 4
     99
0484 9282F880    96       DB 0x92, 0x82, 0xF8, 0x80, 0x90        ; 4 TO 9
     90
0489 8883C6A1    97       DB 0x88, 0x83, 0xC6, 0xA1, 0x86, 0x8E  ; A to F
     868E
048F             98   
048F             99   Wait50ms:
048F            100   ;33.33MHz, 1 clk per cycle: 0.03us
048F 781E       101            mov R0, #30
0491            102   Wait50ms_L3:
0491 794A       103            mov R1, #74
0493            104   Wait50ms_L2:
0493 7AFA       105            mov R2, #250
0495            106   Wait50ms_L1:
0495 DAFE       107            djnz R2, Wait50ms_L1 ;3*250*0.03us=22.5us
0497 D9FA       108       djnz R1, Wait50ms_L2 ;74*22.5us=1.665ms
0499 D8F6       109       djnz R0, Wait50ms_L3 ;1.665ms*30=50ms
049B 22         110       ret
049C            111   
049C            112   Display_Voltage_7seg:
049C            113            
049C 90047F     114            mov dptr, #myLUT
049F            115   
049F E539       116            mov a, bcd+1
04A1 C4         117            swap a
04A2 540F       118            anl a, #0FH
04A4 93         119            movc a, @a+dptr
04A5 547F       120            anl a, #0x7f ; Turn on decimal point
04A7 F594       121            mov HEX3, a
04A9            122            
04A9 E539       123            mov a, bcd+1
04AB 540F       124            anl a, #0FH
04AD 93         125            movc a, @a+dptr
04AE F593       126            mov HEX2, a
04B0            127   
04B0 E538       128            mov a, bcd+0
04B2 C4         129            swap a
04B3 540F       130            anl a, #0FH
04B5 93         131            movc a, @a+dptr
04B6 F592       132            mov HEX1, a
04B8            133            
04B8 E538       134            mov a, bcd+0
04BA 540F       135            anl a, #0FH
04BC 93         136            movc a, @a+dptr
04BD F591       137            mov HEX0, a
04BF            138            
04BF 22         139            ret
04C0            140   
04C0            141   Display_Voltage_LCD:
04C0 C0E0       142            push acc
04C2 7401       142            mov a, #1
04C4 14         142            dec a
04C5 1203DE     142            lcall ?Set_Cursor_2 ; Select column and row
04C8 D0E0       142            pop acc
04CA 7456       143            mov a, #'V'
04CC 120396     144            lcall ?WriteData
04CF 743D       145            mov a, #'='
04D1 120396     146            lcall ?WriteData
04D4            147   
04D4 E539       148            mov a, bcd+1
04D6 C4         149            swap a
04D7 540F       150            anl a, #0FH
04D9 4430       151            orl a, #'0'
04DB 120396     152            lcall ?WriteData
04DE            153            
04DE 742E       154            mov a, #'.'
04E0 120396     155            lcall ?WriteData
04E3            156            
04E3 E539       157            mov a, bcd+1
04E5 540F       158            anl a, #0FH
04E7 4430       159            orl a, #'0'
04E9 120396     160            lcall ?WriteData
04EC            161   
04EC E538       162            mov a, bcd+0
04EE C4         163            swap a
04EF 540F       164            anl a, #0FH
04F1 4430       165            orl a, #'0'
04F3 120396     166            lcall ?WriteData
04F6            167            
04F6 E538       168            mov a, bcd+0
04F8 540F       169            anl a, #0FH
04FA 4430       170            orl a, #'0'
04FC 120396     171            lcall ?WriteData
04FF            172            
04FF 22         173            ret
0500            174            
0500            175   Display_Voltage_Serial:
0500 7456       176            mov a, #'V'
0502 12003F     177            lcall putchar
0505 743D       178            mov a, #'='
0507 12003F     179            lcall putchar
050A            180   
050A E539       181            mov a, bcd+1
050C C4         182            swap a
050D 540F       183            anl a, #0FH
050F 4430       184            orl a, #'0'
0511 12003F     185            lcall putchar
0514            186            
0514 742E       187            mov a, #'.'
0516 12003F     188            lcall putchar
0519            189            
0519 E539       190            mov a, bcd+1
051B 540F       191            anl a, #0FH
051D 4430       192            orl a, #'0'
051F 12003F     193            lcall putchar
0522            194   
0522 E538       195            mov a, bcd+0
0524 C4         196            swap a
0525 540F       197            anl a, #0FH
0527 4430       198            orl a, #'0'
0529 12003F     199            lcall putchar
052C            200            
052C E538       201            mov a, bcd+0
052E 540F       202            anl a, #0FH
0530 4430       203            orl a, #'0'
0532 12003F     204            lcall putchar
0535            205   
0535 740D       206            mov a, #'\r'
0537 12003F     207            lcall putchar
053A 740A       208            mov a, #'\n'
053C 12003F     209            lcall putchar
053F            210            
053F 22         211            ret
0540            212   
0540 566F6C74   213   Initial_Message:  db 'Voltmeter test', 0
     6D657465
     72207465
     737400
054F            214   
054F            215   mycode:
054F 75817F     216            mov SP, #0x7F
0552 E4         217            clr a
0553 F5E8       218            mov LEDRA, a
0555 F595       219            mov LEDRB, a
0557            220            
0557 12002E     221            lcall InitSerialPort
055A            222            
055A            223            ; COnfigure the pins connected to the LCD as outputs
055A 759AAA     224            mov P0MOD, #10101010b ; P0.1, P0.3, P0.5, P0.7 are outputs.  ('1' makes the pin output)
055D 759B82     225       mov P1MOD, #10000010b ; P1.7 and P1.1 are outputs
0560            226   
0560            227       ; Initial PWM output
0560 759D80     228       mov P3MOD, #10000000b   ; P3.7
0563            229   
0563 75A180     230       mov ADC_C, #0x80 ; Reset ADC
0566 12048F     231            lcall Wait50ms
0569            232   
0569 E4         233       clr a
056A F53F       234       mov pwm_tick_counter, a
056C F540       235       mov pwm_on_ticks, a
056E 754100     236       mov pwm, #0
0571            237   
0571 1203FB     238       lcall Timer2_Init
0574 D2AF       239       setb EA              ; Enable global interrupts
0576            240       
0576            241       ; Set initial 0% and apply
0576 754100     242       mov pwm, #0
0579 120469     243       lcall Update_PWM        
057C            244   
057C 1203A0     245       lcall ELCD_4BIT ; Configure LCD in four bit mode
057F            246       ; ; For convenience a few handy macros are included in 'LCD_4bit_DE1Lite.inc':
057F C0E0       247            push acc
0581 7401       247            mov a, #1
0583 14         247            dec a
0584 1203E0     247            lcall ?Set_Cursor_1 ; Select column and row
0587 D0E0       247            pop acc
0589 C083       248            push dph
058B C082       248            push dpl
058D C0E0       248            push acc
058F 900540     248            mov dptr, #Initial_Message
0592 1203D3     248            lcall ?Send_Constant_String
0595 D0E0       248            pop acc
0597 D082       248            pop dpl
0599 D083       248            pop dph
059B            249            
059B            250            ; mov dptr, #Initial_Message
059B            251            ; lcall SendString
059B            252            ; mov a, #'\r'
059B            253            ; lcall putchar
059B            254            ; mov a, #'\n'
059B            255            ; lcall putchar
059B            256   
059B 754132     257       mov pwm, #50
059E 120469     258       lcall Update_PWM
05A1            259   
05A1            260   forever:
05A1 75411E     261       mov pwm, #30
05A4 120469     262       lcall Update_PWM
05A7            263   
05A7 1205AD     264       lcall Read_Temperature
05AA            265            ; lcall Wait50ms
05AA            266            ; lcall Wait50ms
05AA            267            ; lcall Wait50ms
05AA            268            ; lcall Wait50ms
05AA 0205A1     269            ljmp forever
05AD            270   
05AD            271   ; ----------------------------------------
05AD            272   ; TEMPERATURE ROUTINES
05AD            273   ; ----------------------------------------
05AD            274   
05AD            275   Read_Temperature:
05AD F5A1       276       mov ADC_C, a
05AF            277   
05AF            278       ; Load 32-bit 'x' with 12-bit adc result
05AF 753300     279            mov x+3, #0
05B2 753200     280            mov x+2, #0
05B5 85A331     281            mov x+1, ADC_H
05B8 85A230     282            mov x+0, ADC_L
05BB            283   
05BB            284            ; Convert to voltage by multiplying by 5.000 and dividing by 4096
05BB 753488     285            mov y+0, #low (5000 % 0x10000) 
05BE 753513     285            mov y+1, #high(5000 % 0x10000) 
05C1 753600     285            mov y+2, #low (5000 / 0x10000) 
05C4 753700     285            mov y+3, #high(5000 / 0x10000) 
05C7 1201B0     286            lcall mul32
05CA 753400     287            mov y+0, #low (4096 % 0x10000) 
05CD 753510     287            mov y+1, #high(4096 % 0x10000) 
05D0 753600     287            mov y+2, #low (4096 / 0x10000) 
05D3 753700     287            mov y+3, #high(4096 / 0x10000) 
05D6 1202A4     288            lcall div32
05D9            289   
05D9            290       ; Convert the Voltage at the ADC to a temperature:
05D9 7534E8     291            mov y+0, #low (1000 % 0x10000) 
05DC 753503     291            mov y+1, #high(1000 % 0x10000) 
05DF 753600     291            mov y+2, #low (1000 / 0x10000) 
05E2 753700     291            mov y+3, #high(1000 / 0x10000)  ; convert to microvolts
05E5 1201B0     292       lcall mul32
05E8 75340C     293            mov y+0, #low (12300 % 0x10000) 
05EB 753530     293            mov y+1, #high(12300 % 0x10000) 
05EE 753600     293            mov y+2, #low (12300 / 0x10000) 
05F1 753700     293            mov y+3, #high(12300 / 0x10000)  ; 41 * 300
05F4 1202A4     294       lcall div32
05F7            295   
05F7 753416     296            mov y+0, #low (22 % 0x10000) 
05FA 753500     296            mov y+1, #high(22 % 0x10000) 
05FD 753600     296            mov y+2, #low (22 / 0x10000) 
0600 753700     296            mov y+3, #high(22 / 0x10000)  ; add cold junction temperature
0603 1200F7     297       lcall add32
0606            298   
0606 120052     299       lcall hex2bcd
0609 120500     300       lcall Display_Voltage_Serial
060C 22         301       ret
060D            302   
060D            303   en
